{
  "db_name": "PostgreSQL",
  "query": "\n        WITH\n          target_rows AS (\n            SELECT\n              us.id subscription_id,\n              us.user_id,\n              p.metadata product_metadata,\n              c.amount,\n              c.tax_amount,\n              c.due\n            FROM users_subscriptions us\n            INNER JOIN (\n              SELECT DISTINCT ON (subscription_id)\n                subscription_id,\n                due,\n                amount,\n                tax_amount\n              FROM charges\n              WHERE status = 'open'\n              ORDER BY subscription_id, due DESC\n            ) c(subscription_id, due, amount, tax_amount) ON us.id = c.subscription_id\n            INNER JOIN products_prices pp ON pp.id = us.price_id\n            INNER JOIN products p ON p.id = pp.product_id\n            INNER JOIN users u ON u.id = us.user_id\n            WHERE\n              NOW() + INTERVAL '9 days' > c.due\n              AND NOW() + INTERVAL '7 days' < c.due -- Between 7 and 9 days before the due date\n              AND c.tax_amount > 0\n              AND us.status = 'provisioned'\n              AND us.user_aware_of_tax_changes = FALSE\n              AND u.email IS NOT NULL\n            ),\n          taken AS (\n            SELECT target_rows.*\n            FROM users_subscriptions us\n            INNER JOIN target_rows ON us.id = target_rows.subscription_id\n            ORDER BY target_rows.due ASC\n            FOR NO KEY UPDATE SKIP LOCKED\n            LIMIT $1\n          )\n        UPDATE users_subscriptions us\n        SET user_aware_of_tax_changes = TRUE\n        FROM taken t\n        WHERE us.id = t.subscription_id\n        RETURNING t.*\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "subscription_id",
        "type_info": "Int8"
      },
      {
        "ordinal": 1,
        "name": "user_id",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "product_metadata",
        "type_info": "Jsonb"
      },
      {
        "ordinal": 3,
        "name": "amount",
        "type_info": "Int8"
      },
      {
        "ordinal": 4,
        "name": "tax_amount",
        "type_info": "Int8"
      },
      {
        "ordinal": 5,
        "name": "due",
        "type_info": "Timestamptz"
      }
    ],
    "parameters": {
      "Left": [
        "Int8"
      ]
    },
    "nullable": [
      false,
      false,
      false,
      false,
      false,
      false
    ]
  },
  "hash": "33e167e0ffc57614b2d18ec5793e98ad289ca160054a2791f8135dba1f9e6a34"
}
