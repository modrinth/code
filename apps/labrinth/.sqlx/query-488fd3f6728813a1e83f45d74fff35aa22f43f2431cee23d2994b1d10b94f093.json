{
  "db_name": "PostgreSQL",
  "query": "\n        SELECT\n            project_id AS \"project_id: DBProjectId\",\n            project_thread_id AS \"project_thread_id: DBThreadId\",\n            report AS \"report!: sqlx::types::Json<FileReport>\"\n        FROM (\n            SELECT DISTINCT ON (dr.id)\n                dr.id       AS report_id,\n                dr.created  AS report_created,\n                dr.severity AS report_severity,\n                m.id        AS project_id,\n                t.id        AS project_thread_id,\n\n                to_jsonb(dr)\n                || jsonb_build_object(\n                    'file_id', to_base62(f.id),\n                    'version_id', to_base62(v.id),\n                    'project_id', to_base62(v.mod_id),\n                    'file_name', f.filename,\n                    'file_size', f.size,\n                    'flag_reason', 'delphi',\n                    'download_url', f.url,\n                    -- TODO: replace with `json_array` in Postgres 16\n                    'issues', (\n                        SELECT json_agg(\n                            to_jsonb(dri)\n                            || jsonb_build_object(\n                                -- TODO: replace with `json_array` in Postgres 16\n                                'details', (\n                                    SELECT json_agg(\n                                        jsonb_build_object(\n                                            'id', drid.id,\n                                            'issue_id', drid.issue_id,\n                                            'key', drid.key,\n                                            'file_path', drid.file_path,\n                                            -- ignore `decompiled_source`\n                                            'data', drid.data,\n                                            'severity', drid.severity\n                                        )\n                                    )\n                                    FROM delphi_report_issue_details drid\n                                    WHERE drid.issue_id = dri.id\n                                )\n                            )\n                        )\n                        FROM delphi_report_issues dri\n                        WHERE dri.report_id = dr.id\n                        -- AND NOT EXISTS (\n                        --     -- exclude issues with types that have been marked as safe for this project\n                        --     SELECT 1\n                        --     FROM delphi_report_issues dri_safe\n                        --     INNER JOIN delphi_reports dr_safe ON dr_safe.id = dri_safe.report_id\n                        --     INNER JOIN files f_safe ON f_safe.id = dr_safe.file_id\n                        --     INNER JOIN versions v_safe ON v_safe.id = f_safe.version_id\n                        --     WHERE dri_safe.issue_type = dri.issue_type\n                        --     AND dri_safe.status = 'safe'\n                        --     AND v_safe.mod_id = m.id\n                        -- )\n                    )\n                ) AS report\n            FROM delphi_reports dr\n            INNER JOIN files f ON f.id = dr.file_id\n            INNER JOIN versions v ON v.id = f.version_id\n            INNER JOIN mods m ON m.id = v.mod_id\n            INNER JOIN threads t ON t.mod_id = m.id\n\n            -- filtering\n            LEFT JOIN mods_categories mc ON mc.joining_mod_id = m.id\n            LEFT JOIN categories c ON c.id = mc.joining_category_id\n            WHERE\n                -- project type\n                (cardinality($4::int[]) = 0 OR c.project_type = ANY($4::int[]))\n                AND m.status NOT IN ('draft', 'rejected', 'withheld')\n                AND dr.status = 'pending'\n        ) t\n\n        -- sorting\n        ORDER BY\n            CASE WHEN $3 = 'created_asc' THEN t.report_created ELSE TO_TIMESTAMP(0) END ASC,\n            CASE WHEN $3 = 'created_desc' THEN t.report_created ELSE TO_TIMESTAMP(0) END DESC,\n            CASE WHEN $3 = 'severity_asc' THEN t.report_severity ELSE 'low'::delphi_severity END ASC,\n            CASE WHEN $3 = 'severity_desc' THEN t.report_severity ELSE 'low'::delphi_severity END DESC\n\n        -- pagination\n        LIMIT $1\n        OFFSET $2\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "project_id: DBProjectId",
        "type_info": "Int8"
      },
      {
        "ordinal": 1,
        "name": "project_thread_id: DBThreadId",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "report!: sqlx::types::Json<FileReport>",
        "type_info": "Jsonb"
      }
    ],
    "parameters": {
      "Left": [
        "Int8",
        "Int8",
        "Text",
        "Int4Array"
      ]
    },
    "nullable": [
      false,
      false,
      null
    ]
  },
  "hash": "488fd3f6728813a1e83f45d74fff35aa22f43f2431cee23d2994b1d10b94f093"
}
